/*! For license information please see functions.js.LICENSE.txt */
!function(){"use strict";var e=function(e){return e.OctagonAgent="octagon-agent",e}({}),t=function(e){return e.MarketIntelligence="Market Intelligence",e}(t||{});function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function n(e,t,n){return(t=function(e){var t=function(e){if("object"!=r(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==r(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}e.OctagonAgent,t.MarketIntelligence;var o=function(e){return e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e}({}),a=o.ERROR,i=n(n(n(n({},o.DEBUG,0),o.INFO,1),o.WARN,2),o.ERROR,3);function c(e,t,r){if(i[e]>=i[a]){var n=(new Date).toISOString(),c="[".concat(n,"] [").concat(e,"] ").concat(t);switch(e){case o.DEBUG:console.debug(c,r||"");break;case o.INFO:console.info(c,r||"");break;case o.WARN:console.warn(c,r||"");break;case o.ERROR:console.error(c,r||"")}}}var u=function(e,t){return c(o.DEBUG,e,t)},s=function(e,t){return c(o.INFO,e,t)},f=function(e,t){return c(o.WARN,e,t)},l=function(e,t){return c(o.ERROR,e,t)},p={raw:{format:{type:"text"}},table:{format:{type:"json_schema",strict:!0,name:"TableFormat",schema:{properties:{data:{description:"Nested list of values for multiple spreadsheet cells. Outer list represents rows, inner list represents columns. Each element in the inner list is a cell value.",items:{items:{anyOf:[{type:"number"},{type:"string"}]},type:"array"},type:"array"}},required:["data"],title:"ExcelFormat",type:"object",additionalProperties:!1}}},cell:{format:{type:"json_schema",strict:!0,name:"SingleCellFormat",schema:{properties:{data:{anyOf:[{type:"number"},{type:"string"}],description:"Single value of a spreadsheet cell",title:"Data"}},required:["data"],title:"ExcelCell",type:"object",additionalProperties:!1}}}};function y(e){var t=p[e];if(!t)throw l("Invalid format: ".concat(e)),new CustomFunctions.Error(CustomFunctions.ErrorCode.invalidValue,'Invalid format. Please use "raw", "table", or "cell"');return t}function v(e,t){var r=[["No response content"]];try{var n;if("table"==t)return null!==(n=JSON.parse(e).data)&&void 0!==n?n:r;if("cell"==t){var o=JSON.parse(e).data;return void 0!==o?[[o]]:r}return[[e]]}catch(n){return l("Error parsing text format:",{error:n,content:e,format:t}),r}}function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function h(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return d(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?d(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw a}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function b(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof c?n:c,s=Object.create(u.prototype);return g(s,"_invoke",function(r,n,o){var a,c,u,s=0,f=o||[],l=!1,p={p:0,n:0,v:e,a:y,f:y.bind(e,4),d:function(t,r){return a=t,c=0,u=e,p.n=r,i}};function y(r,n){for(c=r,u=n,t=0;!l&&s&&!o&&t<f.length;t++){var o,a=f[t],y=p.p,v=a[2];r>3?(o=v===n)&&(u=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=e):a[0]<=y&&((o=r<2&&y<a[1])?(c=0,p.v=n,p.n=a[1]):y<v&&(o=r<3||a[0]>n||n>v)&&(a[4]=r,a[5]=n,p.n=v,c=0))}if(o||r>1)return i;throw l=!0,n}return function(o,f,v){if(s>1)throw TypeError("Generator is already running");for(l&&1===f&&y(f,v),c=f,u=v;(t=c<2?e:u)||!l;){a||(c?c<3?(c>1&&(p.n=-1),y(c,u)):p.n=u:p.v=u);try{if(s=2,a){if(c||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=a.return)&&t.call(a),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=e}else if((t=(l=p.n<0)?u:r.call(n,p))!==i)break}catch(t){a=e,c=1,u=t}finally{s=1}}return{value:t,done:l}}}(r,o,a),!0),s}var i={};function c(){}function u(){}function s(){}t=Object.getPrototypeOf;var f=[][n]?t(t([][n]())):(g(t={},n,function(){return this}),t),l=s.prototype=c.prototype=Object.create(f);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,g(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=s,g(l,"constructor",s),g(s,"constructor",u),u.displayName="GeneratorFunction",g(s,o,"GeneratorFunction"),g(l),g(l,o,"Generator"),g(l,n,function(){return this}),g(l,"toString",function(){return"[object Generator]"}),(b=function(){return{w:a,m:p}})()}function g(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}g=function(e,t,r,n){function a(t,r){g(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},g(e,t,r,n)}function w(e,t,r,n,o,a,i){try{var c=e[a](i),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,o)}function k(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function i(e){w(a,n,o,i,c,"next",e)}function c(e){w(a,n,o,i,c,"throw",e)}i(void 0)})}}function O(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,A(n.key),n)}}function A(e){var t=function(e){if("object"!=m(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=m(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==m(t)?t:t+""}var E="octagon_api_key",S=function(){return t=function e(){var t,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"https://api-gateway.octagonagents.com";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t=this,(r=A(r="apiKey"))in t?Object.defineProperty(t,r,{value:null,enumerable:!0,configurable:!0,writable:!0}):t[r]=null,this.apiUrl=n},r=[{key:"setApiKey",value:(w=k(b().m(function e(t){var r,n;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=t.trim()||null,this.apiKey=r,r){e.n=2;break}return f("Attempted to set an empty API key; clearing stored key instead"),e.n=1,this.clearApiKey();case 1:return e.a(2);case 2:return e.p=2,e.n=3,OfficeRuntime.storage.setItem(E,r);case 3:u("API key saved to OfficeRuntime.storage"),e.n=5;break;case 4:e.p=4,n=e.v,l("Failed to save API key to OfficeRuntime.storage",n);case 5:return e.a(2)}},e,this,[[2,4]])})),function(e){return w.apply(this,arguments)})},{key:"callAgent",value:(g=k(b().m(function e(t,r,n){var o;return b().w(function(e){for(;;)switch(e.n){case 0:if(u("callAgent invoked with model: ".concat(t,", prompt: ").concat(r.substring(0,50),"...")),r&&""!==r.trim()){e.n=1;break}throw new Error("Please provide a valid prompt");case 1:return e.n=2,this.isAuthenticated();case 2:if(e.v){e.n=3;break}throw l("API request failed: Not authenticated"),new Error("Not authenticated. Please set your API key first.");case 3:return e.n=4,this.createResponse({model:t,input:r,text:y(n)});case 4:return o=e.v,e.a(2,v(o.content||"No response content",n))}},e,this)})),function(e,t,r){return g.apply(this,arguments)})},{key:"loadApiKey",value:(d=k(b().m(function e(){var t;return b().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.getStoredApiKey();case 1:if(!(t=e.v)){e.n=2;break}return this.apiKey=t,e.a(2);case 2:this.apiKey=null;case 3:return e.a(2)}},e,this)})),function(){return d.apply(this,arguments)})},{key:"isAuthenticated",value:(m=k(b().m(function e(){return b().w(function(e){for(;;)switch(e.n){case 0:return s("isAuthenticated invoked - synchronizing API key from storage"),e.n=1,this.loadApiKey();case 1:return e.a(2,!!this.apiKey)}},e,this)})),function(){return m.apply(this,arguments)})},{key:"clearApiKey",value:(p=k(b().m(function e(){var t;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:return this.apiKey=null,e.p=1,e.n=2,OfficeRuntime.storage.removeItem(E);case 2:s("API key cleared from OfficeRuntime.storage"),e.n=4;break;case 3:e.p=3,t=e.v,l("Failed to clear API key from OfficeRuntime.storage",t);case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return p.apply(this,arguments)})},{key:"getStoredApiKey",value:(c=k(b().m(function e(){var t,r;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,OfficeRuntime.storage.getItem(E);case 1:if("string"!=typeof(t=e.v)){e.n=2;break}return e.a(2,t);case 2:e.n=4;break;case 3:e.p=3,r=e.v,l("Failed to read API key from OfficeRuntime.storage",r);case 4:return e.a(2,null)}},e,null,[[0,3]])})),function(){return c.apply(this,arguments)})},{key:"createResponse",value:(i=k(b().m(function e(t,r){var n,o,a,i;return b().w(function(e){for(;;)switch(e.n){case 0:if(n=new URL("/v1/responses",this.apiUrl),o=null!=r?r:this.apiKey){e.n=1;break}throw new Error("No API key provided");case 1:return a=new Headers({"Content-Type":"application/json",Authorization:"Bearer ".concat(o)}),e.n=2,fetch(n,{method:"POST",headers:a,body:JSON.stringify(t)});case 2:if((i=e.v).ok){e.n=3;break}return e.n=3,this.handleApiError(i);case 3:return e.n=4,this.parseAgentResponse(i);case 4:return e.a(2,e.v)}},e,this)})),function(e,t){return i.apply(this,arguments)})},{key:"parseAgentResponse",value:(a=k(b().m(function e(t){var r,n,o,a,i,c,u,s,p,y,v;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,t.json();case 1:if((r=e.v).output&&Array.isArray(r.output)){e.n=2;break}return f("Unexpected response format: missing output array",r),e.a(2,{content:"",id:null==r?void 0:r.id,model:null==r?void 0:r.model});case 2:n="",o=h(r.output),e.p=3,o.s();case 4:if((a=o.n()).done){e.n=15;break}if("message"===(i=a.value).type){e.n=5;break}return e.a(3,14);case 5:if(i.content&&Array.isArray(i.content)){e.n=6;break}return e.a(3,14);case 6:c=h(i.content),e.p=7,c.s();case 8:if((u=c.n()).done){e.n=11;break}if("output_text"===(s=u.value).type){e.n=9;break}return e.a(3,10);case 9:n+=s.text;case 10:e.n=8;break;case 11:e.n=13;break;case 12:e.p=12,p=e.v,c.e(p);case 13:return e.p=13,c.f(),e.f(13);case 14:e.n=4;break;case 15:e.n=17;break;case 16:e.p=16,y=e.v,o.e(y);case 17:return e.p=17,o.f(),e.f(17);case 18:return e.a(2,{content:n,id:r.id,model:r.model});case 19:throw e.p=19,v=e.v,l("Error processing agent response:",v),new Error("Failed to process agent response");case 20:return e.a(2)}},e,null,[[7,12,13,14],[3,16,17,18],[0,19]])})),function(e){return a.apply(this,arguments)})},{key:"testConnection",value:(o=k(b().m(function t(r){var n,o;return b().w(function(t){for(;;)switch(t.p=t.n){case 0:return n={model:e.OctagonAgent,input:"Test connection",max_tokens:10},t.p=1,t.n=2,this.createResponse(n,r);case 2:return t.a(2,!0);case 3:return t.p=3,o=t.v,l("Test connection threw an exception",o),t.a(2,!1)}},t,this,[[1,3]])})),function(e){return o.apply(this,arguments)})},{key:"handleApiError",value:(n=k(b().m(function e(t){var r,n,o,a,i;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,t.json();case 1:o=e.v,e.n=3;break;case 2:e.p=2,e.v,o={detail:"Unknown error"};case 3:throw a=t.status,i=null!==(r=null===(n=o)||void 0===n?void 0:n.detail)&&void 0!==r?r:"Unknown error",l("Agent request failed",{status:a,message:i}),new Error("HTTP ".concat(a,": ").concat(i));case 4:return e.a(2)}},e,null,[[0,2]])})),function(e){return n.apply(this,arguments)})}],r&&O(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,r,n,o,a,i,c,p,m,d,g,w}();function P(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof c?n:c,s=Object.create(u.prototype);return R(s,"_invoke",function(r,n,o){var a,c,u,s=0,f=o||[],l=!1,p={p:0,n:0,v:e,a:y,f:y.bind(e,4),d:function(t,r){return a=t,c=0,u=e,p.n=r,i}};function y(r,n){for(c=r,u=n,t=0;!l&&s&&!o&&t<f.length;t++){var o,a=f[t],y=p.p,v=a[2];r>3?(o=v===n)&&(u=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=e):a[0]<=y&&((o=r<2&&y<a[1])?(c=0,p.v=n,p.n=a[1]):y<v&&(o=r<3||a[0]>n||n>v)&&(a[4]=r,a[5]=n,p.n=v,c=0))}if(o||r>1)return i;throw l=!0,n}return function(o,f,v){if(s>1)throw TypeError("Generator is already running");for(l&&1===f&&y(f,v),c=f,u=v;(t=c<2?e:u)||!l;){a||(c?c<3?(c>1&&(p.n=-1),y(c,u)):p.n=u:p.v=u);try{if(s=2,a){if(c||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=a.return)&&t.call(a),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=e}else if((t=(l=p.n<0)?u:r.call(n,p))!==i)break}catch(t){a=e,c=1,u=t}finally{s=1}}return{value:t,done:l}}}(r,o,a),!0),s}var i={};function c(){}function u(){}function s(){}t=Object.getPrototypeOf;var f=[][n]?t(t([][n]())):(R(t={},n,function(){return this}),t),l=s.prototype=c.prototype=Object.create(f);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,R(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=s,R(l,"constructor",s),R(s,"constructor",u),u.displayName="GeneratorFunction",R(s,o,"GeneratorFunction"),R(l),R(l,o,"Generator"),R(l,n,function(){return this}),R(l,"toString",function(){return"[object Generator]"}),(P=function(){return{w:a,m:p}})()}function R(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}R=function(e,t,r,n){function a(t,r){R(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},R(e,t,r,n)}function j(e,t,r,n,o,a,i){try{var c=e[a](i),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,o)}var I=new S;function F(){var t;return t=P().m(function t(r,n){var o,a;return P().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,o=n?n.toLowerCase():"table",t.n=1,I.callAgent(e.OctagonAgent,r,o);case 1:return t.a(2,t.v);case 2:if(t.p=2,!((a=t.v)instanceof CustomFunctions.Error)){t.n=3;break}throw a;case 3:throw new CustomFunctions.Error(CustomFunctions.ErrorCode.notAvailable,a instanceof Error?a.message:"An unexpected error occurred");case 4:return t.a(2)}},t,null,[[0,2]])}),F=function(){var e=this,r=arguments;return new Promise(function(n,o){var a=t.apply(e,r);function i(e){j(a,n,o,i,c,"next",e)}function c(e){j(a,n,o,i,c,"throw",e)}i(void 0)})},F.apply(this,arguments)}CustomFunctions.associate("AGENT",function(e,t){return F.apply(this,arguments)})}();
//# sourceMappingURL=functions.js.map