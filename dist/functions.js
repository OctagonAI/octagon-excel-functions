/*! For license information please see functions.js.LICENSE.txt */
!function(){"use strict";var e=function(e){return e.OctagonAgent="octagon-agent",e}({}),t=function(e){return e.MarketIntelligence="Market Intelligence",e}(t||{});function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e,t,r){return(t=function(e){var t=function(e){if("object"!=n(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=n(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}e.OctagonAgent,t.MarketIntelligence;var o=function(e){return e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e}({}),a=o.ERROR,i=r(r(r(r({},o.DEBUG,0),o.INFO,1),o.WARN,2),o.ERROR,3);function c(e,t,n){if(i[e]>=i[a]){var r=(new Date).toISOString(),c="[".concat(r,"] [").concat(e,"] ").concat(t);switch(e){case o.DEBUG:console.debug(c,n||"");break;case o.INFO:console.info(c,n||"");break;case o.WARN:console.warn(c,n||"");break;case o.ERROR:console.error(c,n||"")}}}var u=function(e,t){return c(o.DEBUG,e,t)},s=function(e,t){return c(o.INFO,e,t)},f=function(e,t){return c(o.WARN,e,t)},l=function(e,t){return c(o.ERROR,e,t)},p={raw:{format:{type:"text"}},table:{format:{type:"json_schema",strict:!0,name:"TableFormat",schema:{properties:{data:{description:"Nested list of values for multiple spreadsheet cells. Outer list represents rows, inner list represents columns. Each element in the inner list is a cell value.",items:{items:{anyOf:[{type:"number"},{type:"string"}]},type:"array"},type:"array"}},required:["data"],title:"ExcelFormat",type:"object",additionalProperties:!1}}},cell:{format:{type:"json_schema",strict:!0,name:"SingleCellFormat",schema:{properties:{data:{anyOf:[{type:"number"},{type:"string"}],description:"Single value of a spreadsheet cell",title:"Data"}},required:["data"],title:"ExcelCell",type:"object",additionalProperties:!1}}}};function y(e){var t=p[e];if(!t)throw l("Invalid format: ".concat(e)),new CustomFunctions.Error(CustomFunctions.ErrorCode.invalidValue,'Invalid format. Please use "raw", "table", or "cell"');return t}function v(e,t){var n=[["No response content"]];try{var r;if("table"==t)return null!==(r=JSON.parse(e).data)&&void 0!==r?r:n;if("cell"==t){var o=JSON.parse(e).data;return void 0!==o?[[o]]:n}return[[e]]}catch(r){return l("Error parsing text format:",{error:r,content:e,format:t}),n}}function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function h(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return d(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?d(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){c=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(c)throw a}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function b(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var u=r&&r.prototype instanceof c?r:c,s=Object.create(u.prototype);return g(s,"_invoke",function(n,r,o){var a,c,u,s=0,f=o||[],l=!1,p={p:0,n:0,v:e,a:y,f:y.bind(e,4),d:function(t,n){return a=t,c=0,u=e,p.n=n,i}};function y(n,r){for(c=n,u=r,t=0;!l&&s&&!o&&t<f.length;t++){var o,a=f[t],y=p.p,v=a[2];n>3?(o=v===r)&&(u=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=e):a[0]<=y&&((o=n<2&&y<a[1])?(c=0,p.v=r,p.n=a[1]):y<v&&(o=n<3||a[0]>r||r>v)&&(a[4]=n,a[5]=r,p.n=v,c=0))}if(o||n>1)return i;throw l=!0,r}return function(o,f,v){if(s>1)throw TypeError("Generator is already running");for(l&&1===f&&y(f,v),c=f,u=v;(t=c<2?e:u)||!l;){a||(c?c<3?(c>1&&(p.n=-1),y(c,u)):p.n=u:p.v=u);try{if(s=2,a){if(c||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=a.return)&&t.call(a),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=e}else if((t=(l=p.n<0)?u:n.call(r,p))!==i)break}catch(t){a=e,c=1,u=t}finally{s=1}}return{value:t,done:l}}}(n,o,a),!0),s}var i={};function c(){}function u(){}function s(){}t=Object.getPrototypeOf;var f=[][r]?t(t([][r]())):(g(t={},r,function(){return this}),t),l=s.prototype=c.prototype=Object.create(f);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,g(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=s,g(l,"constructor",s),g(s,"constructor",u),u.displayName="GeneratorFunction",g(s,o,"GeneratorFunction"),g(l),g(l,o,"Generator"),g(l,r,function(){return this}),g(l,"toString",function(){return"[object Generator]"}),(b=function(){return{w:a,m:p}})()}function g(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}g=function(e,t,n,r){function a(t,n){g(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},g(e,t,n,r)}function w(e,t,n,r,o,a,i){try{var c=e[a](i),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}function k(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){w(a,r,o,i,c,"next",e)}function c(e){w(a,r,o,i,c,"throw",e)}i(void 0)})}}function O(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,A(r.key),r)}}function A(e){var t=function(e){if("object"!=m(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=m(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==m(t)?t:t+""}var E="octagon_api_key",S=function(){return t=function e(){var t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"https://api-gateway.octagonagents.com";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t=this,(n=A(n="apiKey"))in t?Object.defineProperty(t,n,{value:null,enumerable:!0,configurable:!0,writable:!0}):t[n]=null,this.apiUrl=r},n=[{key:"setApiKey",value:(w=k(b().m(function e(t){var n,r;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.trim()||null,this.apiKey=n,n){e.n=2;break}return f("Attempted to set an empty API key; clearing stored key instead"),e.n=1,this.clearApiKey();case 1:return e.a(2);case 2:return e.p=2,e.n=3,OfficeRuntime.storage.setItem(E,n);case 3:u("API key saved to OfficeRuntime.storage"),e.n=5;break;case 4:e.p=4,r=e.v,l("Failed to save API key to OfficeRuntime.storage",r);case 5:return e.a(2)}},e,this,[[2,4]])})),function(e){return w.apply(this,arguments)})},{key:"callAgent",value:(g=k(b().m(function e(t,n,r){var o;return b().w(function(e){for(;;)switch(e.n){case 0:if(u("callAgent invoked with model: ".concat(t,", prompt: ").concat(n.substring(0,50),"...")),n&&""!==n.trim()){e.n=1;break}throw new Error("Please provide a valid prompt");case 1:return e.n=2,this.isAuthenticated();case 2:if(e.v){e.n=3;break}throw l("API request failed: Not authenticated"),new Error("Not authenticated. Please set your API key first.");case 3:return e.n=4,this.createResponse({model:t,input:n,text:y(r)});case 4:return o=e.v,e.a(2,v(o.content||"No response content",r))}},e,this)})),function(e,t,n){return g.apply(this,arguments)})},{key:"loadApiKey",value:(d=k(b().m(function e(){var t;return b().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.getStoredApiKey();case 1:if(!(t=e.v)){e.n=2;break}return this.apiKey=t,e.a(2);case 2:this.apiKey=null;case 3:return e.a(2)}},e,this)})),function(){return d.apply(this,arguments)})},{key:"isAuthenticated",value:(m=k(b().m(function e(){return b().w(function(e){for(;;)switch(e.n){case 0:return s("isAuthenticated invoked - synchronizing API key from storage"),e.n=1,this.loadApiKey();case 1:return e.a(2,!!this.apiKey)}},e,this)})),function(){return m.apply(this,arguments)})},{key:"clearApiKey",value:(p=k(b().m(function e(){var t;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:return this.apiKey=null,e.p=1,e.n=2,OfficeRuntime.storage.removeItem(E);case 2:s("API key cleared from OfficeRuntime.storage"),e.n=4;break;case 3:e.p=3,t=e.v,l("Failed to clear API key from OfficeRuntime.storage",t);case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return p.apply(this,arguments)})},{key:"getStoredApiKey",value:(c=k(b().m(function e(){var t,n;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,OfficeRuntime.storage.getItem(E);case 1:if("string"!=typeof(t=e.v)){e.n=2;break}return e.a(2,t);case 2:e.n=4;break;case 3:e.p=3,n=e.v,l("Failed to read API key from OfficeRuntime.storage",n);case 4:return e.a(2,null)}},e,null,[[0,3]])})),function(){return c.apply(this,arguments)})},{key:"createResponse",value:(i=k(b().m(function e(t,n){var r,o,a,i;return b().w(function(e){for(;;)switch(e.n){case 0:if(r=new URL("/v1/responses",this.apiUrl),o=null!=n?n:this.apiKey){e.n=1;break}throw new Error("No API key provided");case 1:return a=new Headers({"Content-Type":"application/json",Authorization:"Bearer ".concat(o)}),e.n=2,fetch(r,{method:"POST",headers:a,body:JSON.stringify(t)});case 2:if((i=e.v).ok){e.n=3;break}return e.n=3,this.handleApiError(i);case 3:return e.n=4,this.parseAgentResponse(i);case 4:return e.a(2,e.v)}},e,this)})),function(e,t){return i.apply(this,arguments)})},{key:"parseAgentResponse",value:(a=k(b().m(function e(t){var n,r,o,a,i,c,u,s,p,y,v;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,t.json();case 1:if((n=e.v).output&&Array.isArray(n.output)){e.n=2;break}return f("Unexpected response format: missing output array",n),e.a(2,{content:"",id:null==n?void 0:n.id,model:null==n?void 0:n.model});case 2:r="",o=h(n.output),e.p=3,o.s();case 4:if((a=o.n()).done){e.n=15;break}if("message"===(i=a.value).type){e.n=5;break}return e.a(3,14);case 5:if(i.content&&Array.isArray(i.content)){e.n=6;break}return e.a(3,14);case 6:c=h(i.content),e.p=7,c.s();case 8:if((u=c.n()).done){e.n=11;break}if("output_text"===(s=u.value).type){e.n=9;break}return e.a(3,10);case 9:r+=s.text;case 10:e.n=8;break;case 11:e.n=13;break;case 12:e.p=12,p=e.v,c.e(p);case 13:return e.p=13,c.f(),e.f(13);case 14:e.n=4;break;case 15:e.n=17;break;case 16:e.p=16,y=e.v,o.e(y);case 17:return e.p=17,o.f(),e.f(17);case 18:return e.a(2,{content:r,id:n.id,model:n.model});case 19:throw e.p=19,v=e.v,l("Error processing agent response:",v),new Error("Failed to process agent response");case 20:return e.a(2)}},e,null,[[7,12,13,14],[3,16,17,18],[0,19]])})),function(e){return a.apply(this,arguments)})},{key:"testConnection",value:(o=k(b().m(function t(n){var r,o;return b().w(function(t){for(;;)switch(t.p=t.n){case 0:return r={model:e.OctagonAgent,input:"Test connection",max_tokens:10},t.p=1,t.n=2,this.createResponse(r,n);case 2:return t.a(2,!0);case 3:return t.p=3,o=t.v,l("Test connection threw an exception",o),t.a(2,!1)}},t,this,[[1,3]])})),function(e){return o.apply(this,arguments)})},{key:"handleApiError",value:(r=k(b().m(function e(t){var n,r,o,a,i;return b().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,t.json();case 1:o=e.v,e.n=3;break;case 2:e.p=2,e.v,o={detail:"Unknown error"};case 3:throw a=t.status,i=null!==(n=null===(r=o)||void 0===r?void 0:r.detail)&&void 0!==n?n:"Unknown error",l("Agent request failed",{status:a,message:i}),new Error("HTTP ".concat(a,": ").concat(i));case 4:return e.a(2)}},e,null,[[0,2]])})),function(e){return r.apply(this,arguments)})}],n&&O(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,r,o,a,i,c,p,m,d,g,w}();function R(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var u=r&&r.prototype instanceof c?r:c,s=Object.create(u.prototype);return P(s,"_invoke",function(n,r,o){var a,c,u,s=0,f=o||[],l=!1,p={p:0,n:0,v:e,a:y,f:y.bind(e,4),d:function(t,n){return a=t,c=0,u=e,p.n=n,i}};function y(n,r){for(c=n,u=r,t=0;!l&&s&&!o&&t<f.length;t++){var o,a=f[t],y=p.p,v=a[2];n>3?(o=v===r)&&(u=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=e):a[0]<=y&&((o=n<2&&y<a[1])?(c=0,p.v=r,p.n=a[1]):y<v&&(o=n<3||a[0]>r||r>v)&&(a[4]=n,a[5]=r,p.n=v,c=0))}if(o||n>1)return i;throw l=!0,r}return function(o,f,v){if(s>1)throw TypeError("Generator is already running");for(l&&1===f&&y(f,v),c=f,u=v;(t=c<2?e:u)||!l;){a||(c?c<3?(c>1&&(p.n=-1),y(c,u)):p.n=u:p.v=u);try{if(s=2,a){if(c||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=a.return)&&t.call(a),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=e}else if((t=(l=p.n<0)?u:n.call(r,p))!==i)break}catch(t){a=e,c=1,u=t}finally{s=1}}return{value:t,done:l}}}(n,o,a),!0),s}var i={};function c(){}function u(){}function s(){}t=Object.getPrototypeOf;var f=[][r]?t(t([][r]())):(P(t={},r,function(){return this}),t),l=s.prototype=c.prototype=Object.create(f);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,P(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=s,P(l,"constructor",s),P(s,"constructor",u),u.displayName="GeneratorFunction",P(s,o,"GeneratorFunction"),P(l),P(l,o,"Generator"),P(l,r,function(){return this}),P(l,"toString",function(){return"[object Generator]"}),(R=function(){return{w:a,m:p}})()}function P(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}P=function(e,t,n,r){function a(t,n){P(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},P(e,t,n,r)}function j(e,t,n,r,o,a,i){try{var c=e[a](i),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}function I(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){j(a,r,o,i,c,"next",e)}function c(e){j(a,r,o,i,c,"throw",e)}i(void 0)})}}var T=new S;function F(e,t){return N.apply(this,arguments)}function N(){return(N=I(R().m(function t(n,r){var o,a;return R().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,o=r?r.toLowerCase():"table",t.n=1,T.callAgent(e.OctagonAgent,n,o);case 1:return t.a(2,t.v);case 2:if(t.p=2,!((a=t.v)instanceof CustomFunctions.Error)){t.n=3;break}throw a;case 3:throw new CustomFunctions.Error(CustomFunctions.ErrorCode.notAvailable,a instanceof Error?a.message:"An unexpected error occurred");case 4:return t.a(2)}},t,null,[[0,2]])}))).apply(this,arguments)}Office.onReady(I(R().m(function e(){return R().w(function(e){for(;;)switch(e.n){case 0:try{u("Office is ready - initializing Octagon functions"),CustomFunctions.associate("OCTAGON.AGENT",F)}catch(e){l("Error during initialization:",e)}case 1:return e.a(2)}},e)}))),CustomFunctions.associate("AGENT",F)}();
//# sourceMappingURL=functions.js.map