/*! For license information please see functions.js.LICENSE.txt */
!function(){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t,r,n){return(r=function(t){var r=function(t){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!=e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(r)?r:r+""}(r))in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t}var r=function(e){return e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e}({}),n=r.ERROR,o=t(t(t(t({},r.DEBUG,0),r.INFO,1),r.WARN,2),r.ERROR,3);function a(e,t,a){if(o[e]>=o[n]){var i=(new Date).toISOString(),c="[".concat(i,"] [").concat(e,"] ").concat(t);switch(e){case r.DEBUG:console.debug(c,a||"");break;case r.INFO:console.info(c,a||"");break;case r.WARN:console.warn(c,a||"");break;case r.ERROR:console.error(c,a||"")}}}var i=function(e,t){return a(r.DEBUG,e,t)},c=function(e,t){return a(r.INFO,e,t)},u=function(e,t){return a(r.WARN,e,t)},s=function(e,t){return a(r.ERROR,e,t)},f={raw:{format:{type:"text"}},table:{format:{type:"json_schema",strict:!0,name:"TableFormat",schema:{properties:{data:{description:"Nested list of values for multiple spreadsheet cells. Outer list represents rows, inner list represents columns. Each element in the inner list is a cell value.",items:{items:{anyOf:[{type:"number"},{type:"string"}]},type:"array"},type:"array"}},required:["data"],title:"ExcelFormat",type:"object",additionalProperties:!1}}},cell:{format:{type:"json_schema",strict:!0,name:"SingleCellFormat",schema:{properties:{data:{anyOf:[{type:"number"},{type:"string"}],description:"Single value of a spreadsheet cell",title:"Data"}},required:["data"],title:"ExcelCell",type:"object",additionalProperties:!1}}}};function l(e){var t=f[e];if(!t)throw s("Invalid format: ".concat(e)),new CustomFunctions.Error(CustomFunctions.ErrorCode.invalidValue,'Invalid format. Please use "raw", "table", or "cell"');return t}function p(e,t){var r=[["No response content"]];try{var n;if("table"==t)return null!==(n=JSON.parse(e).data)&&void 0!==n?n:r;if("cell"==t){var o=JSON.parse(e).data;return void 0!==o?[[o]]:r}return[[e]]}catch(n){return s("Error parsing text format:",{error:n,content:e,format:t}),r}}var y=function(e){return e.OctagonAgent="octagon-agent",e}({});function v(e){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v(e)}function m(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return h(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?h(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){c=!0,a=e},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw a}}}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function d(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof c?n:c,s=Object.create(u.prototype);return b(s,"_invoke",function(r,n,o){var a,c,u,s=0,f=o||[],l=!1,p={p:0,n:0,v:e,a:y,f:y.bind(e,4),d:function(t,r){return a=t,c=0,u=e,p.n=r,i}};function y(r,n){for(c=r,u=n,t=0;!l&&s&&!o&&t<f.length;t++){var o,a=f[t],y=p.p,v=a[2];r>3?(o=v===n)&&(u=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=e):a[0]<=y&&((o=r<2&&y<a[1])?(c=0,p.v=n,p.n=a[1]):y<v&&(o=r<3||a[0]>n||n>v)&&(a[4]=r,a[5]=n,p.n=v,c=0))}if(o||r>1)return i;throw l=!0,n}return function(o,f,v){if(s>1)throw TypeError("Generator is already running");for(l&&1===f&&y(f,v),c=f,u=v;(t=c<2?e:u)||!l;){a||(c?c<3?(c>1&&(p.n=-1),y(c,u)):p.n=u:p.v=u);try{if(s=2,a){if(c||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=a.return)&&t.call(a),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=e}else if((t=(l=p.n<0)?u:r.call(n,p))!==i)break}catch(t){a=e,c=1,u=t}finally{s=1}}return{value:t,done:l}}}(r,o,a),!0),s}var i={};function c(){}function u(){}function s(){}t=Object.getPrototypeOf;var f=[][n]?t(t([][n]())):(b(t={},n,function(){return this}),t),l=s.prototype=c.prototype=Object.create(f);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,b(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=s,b(l,"constructor",s),b(s,"constructor",u),u.displayName="GeneratorFunction",b(s,o,"GeneratorFunction"),b(l),b(l,o,"Generator"),b(l,n,function(){return this}),b(l,"toString",function(){return"[object Generator]"}),(d=function(){return{w:a,m:p}})()}function b(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}b=function(e,t,r,n){function a(t,r){b(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},b(e,t,r,n)}function g(e,t,r,n,o,a,i){try{var c=e[a](i),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,o)}function w(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function i(e){g(a,n,o,i,c,"next",e)}function c(e){g(a,n,o,i,c,"throw",e)}i(void 0)})}}function k(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,O(n.key),n)}}function O(e){var t=function(e){if("object"!=v(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=v(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==v(t)?t:t+""}var A="octagon_api_key",E=function(){return e=function e(){var t,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"https://api-gateway.octagonagents.com";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t=this,(r=O(r="apiKey"))in t?Object.defineProperty(t,r,{value:null,enumerable:!0,configurable:!0,writable:!0}):t[r]=null,this.apiUrl=n},t=[{key:"setApiKey",value:(E=w(d().m(function e(t){var r,n;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=t.trim()||null,this.apiKey=r,r){e.n=2;break}return u("Attempted to set an empty API key; clearing stored key instead"),e.n=1,this.clearApiKey();case 1:return e.a(2);case 2:return e.p=2,e.n=3,OfficeRuntime.storage.setItem(A,r);case 3:i("API key saved to OfficeRuntime.storage"),e.n=5;break;case 4:e.p=4,n=e.v,s("Failed to save API key to OfficeRuntime.storage",n);case 5:return e.a(2)}},e,this,[[2,4]])})),function(e){return E.apply(this,arguments)})},{key:"callAgent",value:(g=w(d().m(function e(t,r,n){var o;return d().w(function(e){for(;;)switch(e.n){case 0:if(i("callAgent invoked with model: ".concat(t,", prompt: ").concat(r.substring(0,50),"...")),r&&""!==r.trim()){e.n=1;break}throw new Error("Please provide a valid prompt");case 1:return e.n=2,this.isAuthenticated();case 2:if(e.v){e.n=3;break}throw s("API request failed: Not authenticated"),new Error("Not authenticated. Please set your API key first.");case 3:return e.n=4,this.createResponse({model:t,input:r,text:l(n)});case 4:return o=e.v,e.a(2,p(o.content||"No response content",n))}},e,this)})),function(e,t,r){return g.apply(this,arguments)})},{key:"loadApiKey",value:(b=w(d().m(function e(){var t;return d().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.getStoredApiKey();case 1:if(!(t=e.v)){e.n=2;break}return this.apiKey=t,e.a(2);case 2:this.apiKey=null;case 3:return e.a(2)}},e,this)})),function(){return b.apply(this,arguments)})},{key:"isAuthenticated",value:(h=w(d().m(function e(){return d().w(function(e){for(;;)switch(e.n){case 0:return c("isAuthenticated invoked - synchronizing API key from storage"),e.n=1,this.loadApiKey();case 1:return e.a(2,!!this.apiKey)}},e,this)})),function(){return h.apply(this,arguments)})},{key:"clearApiKey",value:(v=w(d().m(function e(){var t;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return this.apiKey=null,e.p=1,e.n=2,OfficeRuntime.storage.removeItem(A);case 2:c("API key cleared from OfficeRuntime.storage"),e.n=4;break;case 3:e.p=3,t=e.v,s("Failed to clear API key from OfficeRuntime.storage",t);case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return v.apply(this,arguments)})},{key:"getStoredApiKey",value:(f=w(d().m(function e(){var t,r;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,OfficeRuntime.storage.getItem(A);case 1:if("string"!=typeof(t=e.v)){e.n=2;break}return e.a(2,t);case 2:e.n=4;break;case 3:e.p=3,r=e.v,s("Failed to read API key from OfficeRuntime.storage",r);case 4:return e.a(2,null)}},e,null,[[0,3]])})),function(){return f.apply(this,arguments)})},{key:"createResponse",value:(a=w(d().m(function e(t,r){var n,o,a,i;return d().w(function(e){for(;;)switch(e.n){case 0:if(n=new URL("/v1/responses",this.apiUrl),o=null!=r?r:this.apiKey){e.n=1;break}throw new Error("No API key provided");case 1:return a=new Headers({"Content-Type":"application/json",Authorization:"Bearer ".concat(o)}),e.n=2,fetch(n,{method:"POST",headers:a,body:JSON.stringify(t)});case 2:if((i=e.v).ok){e.n=3;break}return e.n=3,this.handleApiError(i);case 3:return e.n=4,this.parseAgentResponse(i);case 4:return e.a(2,e.v)}},e,this)})),function(e,t){return a.apply(this,arguments)})},{key:"parseAgentResponse",value:(o=w(d().m(function e(t){var r,n,o,a,i,c,f,l,p,y,v;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,t.json();case 1:if((r=e.v).output&&Array.isArray(r.output)){e.n=2;break}return u("Unexpected response format: missing output array",r),e.a(2,{content:"",id:null==r?void 0:r.id,model:null==r?void 0:r.model});case 2:n="",o=m(r.output),e.p=3,o.s();case 4:if((a=o.n()).done){e.n=15;break}if("message"===(i=a.value).type){e.n=5;break}return e.a(3,14);case 5:if(i.content&&Array.isArray(i.content)){e.n=6;break}return e.a(3,14);case 6:c=m(i.content),e.p=7,c.s();case 8:if((f=c.n()).done){e.n=11;break}if("output_text"===(l=f.value).type){e.n=9;break}return e.a(3,10);case 9:n+=l.text;case 10:e.n=8;break;case 11:e.n=13;break;case 12:e.p=12,p=e.v,c.e(p);case 13:return e.p=13,c.f(),e.f(13);case 14:e.n=4;break;case 15:e.n=17;break;case 16:e.p=16,y=e.v,o.e(y);case 17:return e.p=17,o.f(),e.f(17);case 18:return e.a(2,{content:n,id:r.id,model:r.model});case 19:throw e.p=19,v=e.v,s("Error processing agent response:",v),new Error("Failed to process agent response");case 20:return e.a(2)}},e,null,[[7,12,13,14],[3,16,17,18],[0,19]])})),function(e){return o.apply(this,arguments)})},{key:"testConnection",value:(n=w(d().m(function e(t){var r,n;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return r={model:y.OctagonAgent,input:"Test connection",max_tokens:10},e.p=1,e.n=2,this.createResponse(r,t);case 2:return e.a(2,!0);case 3:return e.p=3,n=e.v,s("Test connection threw an exception",n),e.a(2,!1)}},e,this,[[1,3]])})),function(e){return n.apply(this,arguments)})},{key:"handleApiError",value:(r=w(d().m(function e(t){var r,n,o,a,i;return d().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,t.json();case 1:o=e.v,e.n=3;break;case 2:e.p=2,e.v,o={detail:"Unknown error"};case 3:throw a=t.status,i=null!==(r=null===(n=o)||void 0===n?void 0:n.detail)&&void 0!==r?r:"Unknown error",s("Agent request failed",{status:a,message:i}),new Error("HTTP ".concat(a,": ").concat(i));case 4:return e.a(2)}},e,null,[[0,2]])})),function(e){return r.apply(this,arguments)})}],t&&k(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,r,n,o,a,f,v,h,b,g,E}();function S(){var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof c?n:c,s=Object.create(u.prototype);return P(s,"_invoke",function(r,n,o){var a,c,u,s=0,f=o||[],l=!1,p={p:0,n:0,v:e,a:y,f:y.bind(e,4),d:function(t,r){return a=t,c=0,u=e,p.n=r,i}};function y(r,n){for(c=r,u=n,t=0;!l&&s&&!o&&t<f.length;t++){var o,a=f[t],y=p.p,v=a[2];r>3?(o=v===n)&&(u=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=e):a[0]<=y&&((o=r<2&&y<a[1])?(c=0,p.v=n,p.n=a[1]):y<v&&(o=r<3||a[0]>n||n>v)&&(a[4]=r,a[5]=n,p.n=v,c=0))}if(o||r>1)return i;throw l=!0,n}return function(o,f,v){if(s>1)throw TypeError("Generator is already running");for(l&&1===f&&y(f,v),c=f,u=v;(t=c<2?e:u)||!l;){a||(c?c<3?(c>1&&(p.n=-1),y(c,u)):p.n=u:p.v=u);try{if(s=2,a){if(c||(o="next"),t=a[o]){if(!(t=t.call(a,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=a.return)&&t.call(a),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=e}else if((t=(l=p.n<0)?u:r.call(n,p))!==i)break}catch(t){a=e,c=1,u=t}finally{s=1}}return{value:t,done:l}}}(r,o,a),!0),s}var i={};function c(){}function u(){}function s(){}t=Object.getPrototypeOf;var f=[][n]?t(t([][n]())):(P(t={},n,function(){return this}),t),l=s.prototype=c.prototype=Object.create(f);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,P(e,o,"GeneratorFunction")),e.prototype=Object.create(l),e}return u.prototype=s,P(l,"constructor",s),P(s,"constructor",u),u.displayName="GeneratorFunction",P(s,o,"GeneratorFunction"),P(l),P(l,o,"Generator"),P(l,n,function(){return this}),P(l,"toString",function(){return"[object Generator]"}),(S=function(){return{w:a,m:p}})()}function P(e,t,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}P=function(e,t,r,n){function a(t,r){P(e,t,function(e){return this._invoke(t,r,e)})}t?o?o(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(a("next",0),a("throw",1),a("return",2))},P(e,t,r,n)}function R(e,t,r,n,o,a,i){try{var c=e[a](i),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,o)}var j=new E;function F(){var e;return e=S().m(function e(t,r){var n,o;return S().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,n=r?r.toLowerCase():"table",e.n=1,j.callAgent(y.OctagonAgent,t,n);case 1:return e.a(2,e.v);case 2:if(e.p=2,!((o=e.v)instanceof CustomFunctions.Error)){e.n=3;break}throw o;case 3:throw new CustomFunctions.Error(CustomFunctions.ErrorCode.notAvailable,o instanceof Error?o.message:"An unexpected error occurred");case 4:return e.a(2)}},e,null,[[0,2]])}),F=function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function i(e){R(a,n,o,i,c,"next",e)}function c(e){R(a,n,o,i,c,"throw",e)}i(void 0)})},F.apply(this,arguments)}CustomFunctions.associate("AGENT",function(e,t){return F.apply(this,arguments)})}();
//# sourceMappingURL=functions.js.map