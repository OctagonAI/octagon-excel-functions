/*! For license information please see functions.js.LICENSE.txt */
!function(){"use strict";var e=function(e){return e.OctagonAgent="octagon-agent",e}({}),t=function(e){return e.MarketIntelligence="Market Intelligence",e}(t||{});function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function r(e,t,r){return(t=function(e){var t=function(e){if("object"!=n(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=n(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==n(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}e.OctagonAgent,t.MarketIntelligence;var o=function(e){return e.DEBUG="DEBUG",e.INFO="INFO",e.WARN="WARN",e.ERROR="ERROR",e}({}),i=o.ERROR,a=r(r(r(r({},o.DEBUG,0),o.INFO,1),o.WARN,2),o.ERROR,3);function c(e,t,n){if(a[e]>=a[i]){var r=(new Date).toISOString(),c="[".concat(r,"] [").concat(e,"] ").concat(t);switch(e){case o.DEBUG:console.debug(c,n||"");break;case o.INFO:console.info(c,n||"");break;case o.WARN:console.warn(c,n||"");break;case o.ERROR:console.error(c,n||"")}}}var s=function(e,t){return c(o.DEBUG,e,t)},u=function(e,t){return c(o.INFO,e,t)},l=function(e,t){return c(o.WARN,e,t)},f=function(e,t){return c(o.ERROR,e,t)},p={raw:{format:{type:"text"}},table:{format:{type:"json_schema",strict:!0,name:"TableFormat",schema:{properties:{data:{description:"Nested list of values for multiple spreadsheet cells. Outer list represents rows, inner list represents columns. Each element in the inner list is a cell value.",items:{items:{anyOf:[{type:"number"},{type:"string"}]},type:"array"},type:"array"}},required:["data"],title:"ExcelFormat",type:"object",additionalProperties:!1}}},single_cell:{format:{type:"json_schema",strict:!0,name:"SingleCellFormat",schema:{properties:{data:{anyOf:[{type:"number"},{type:"string"}],description:"Single value of a spreadsheet cell",title:"Data"}},required:["data"],title:"ExcelCell",type:"object",additionalProperties:!1}}}};function y(e){var t=p[e];if(!t)throw f("Invalid format: ".concat(e)),new CustomFunctions.Error(CustomFunctions.ErrorCode.invalidValue,'Invalid format. Please use "raw", "table", or "single_cell"');return t}function v(e,t){return u("Parsing text format:",{content:e,format:t}),"table"==t?JSON.parse(e).data:"single_cell"==t?[[JSON.parse(e).data]]:[[e]]}function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function h(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return g(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?g(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){c=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(c)throw i}}}}function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function m(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var s=r&&r.prototype instanceof c?r:c,u=Object.create(s.prototype);return b(u,"_invoke",function(n,r,o){var i,c,s,u=0,l=o||[],f=!1,p={p:0,n:0,v:e,a:y,f:y.bind(e,4),d:function(t,n){return i=t,c=0,s=e,p.n=n,a}};function y(n,r){for(c=n,s=r,t=0;!f&&u&&!o&&t<l.length;t++){var o,i=l[t],y=p.p,v=i[2];n>3?(o=v===r)&&(s=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=e):i[0]<=y&&((o=n<2&&y<i[1])?(c=0,p.v=r,p.n=i[1]):y<v&&(o=n<3||i[0]>r||r>v)&&(i[4]=n,i[5]=r,p.n=v,c=0))}if(o||n>1)return a;throw f=!0,r}return function(o,l,v){if(u>1)throw TypeError("Generator is already running");for(f&&1===l&&y(l,v),c=l,s=v;(t=c<2?e:s)||!f;){i||(c?c<3?(c>1&&(p.n=-1),y(c,s)):p.n=s:p.v=s);try{if(u=2,i){if(c||(o="next"),t=i[o]){if(!(t=t.call(i,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,c<2&&(c=0)}else 1===c&&(t=i.return)&&t.call(i),c<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=e}else if((t=(f=p.n<0)?s:n.call(r,p))!==a)break}catch(t){i=e,c=1,s=t}finally{u=1}}return{value:t,done:f}}}(n,o,i),!0),u}var a={};function c(){}function s(){}function u(){}t=Object.getPrototypeOf;var l=[][r]?t(t([][r]())):(b(t={},r,function(){return this}),t),f=u.prototype=c.prototype=Object.create(l);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,b(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return s.prototype=u,b(f,"constructor",u),b(u,"constructor",s),s.displayName="GeneratorFunction",b(u,o,"GeneratorFunction"),b(f),b(f,o,"Generator"),b(f,r,function(){return this}),b(f,"toString",function(){return"[object Generator]"}),(m=function(){return{w:i,m:p}})()}function b(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}b=function(e,t,n,r){function i(t,n){b(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},b(e,t,n,r)}function S(e,t,n,r,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,o)}function w(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){S(i,r,o,a,c,"next",e)}function c(e){S(i,r,o,a,c,"throw",e)}a(void 0)})}}function O(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,A(r.key),r)}}function k(e,t,n){return(t=A(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function A(e){var t=function(e){if("object"!=d(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=d(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==d(t)?t:t+""}var I="octagon_api_key",P="CachedSessionSettings",E=function(){return t=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"https://octagon-api-gateway-staging.onrender.com";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),k(this,"apiKey",null),k(this,"isOfficeInitialized",!1),this.apiUrl=t,u("OctagonApiService created with API URL: ".concat(this.apiUrl))},n=[{key:"initialize",value:function(){this.isOfficeInitialized=!0,this.loadApiKey(),u("OctagonApiService fully initialized. API key status: ".concat(this.isAuthenticated()?"Available":"Not available"))}},{key:"checkForStoredApiKey",value:function(){try{var e=sessionStorage.getItem(P);if(e){var t=JSON.parse(e);if(t&&t.octagon_api_key)return u("Found API key in CachedSessionSettings"),!0}if(sessionStorage.getItem(I))return u("Found API key in direct SessionStorage"),!0}catch(e){f("Error checking for stored API key",e)}return!1}},{key:"setApiKey",value:function(e){this.apiKey=e,this.saveApiKey(e)}},{key:"saveApiKey",value:function(e){try{sessionStorage.setItem(I,e);try{var t=sessionStorage.getItem(P);if(t){var n=JSON.parse(t);n.octagon_api_key=e,sessionStorage.setItem(P,JSON.stringify(n))}else{var r={octagon_api_key:e};sessionStorage.setItem(P,JSON.stringify(r))}}catch(e){l("Failed to save to CachedSessionSettings",e)}u("API key saved to SessionStorage")}catch(e){f("Failed to save API key to SessionStorage",e)}}},{key:"callAgent",value:(a=w(m().m(function e(t,n,r){var o,i,a,c;return m().w(function(e){for(;;)switch(e.n){case 0:if(s("callAgent invoked with model: ".concat(t,", prompt: ").concat(n.substring(0,50),"...")),n&&""!==n.trim()){e.n=1;break}throw new Error("Please provide a valid prompt");case 1:if(i=null!=r?r:"table",s("Calling agent...",{isAuthenticated:this.isAuthenticated(),apiKey:this.apiKey}),this.isAuthenticated()){e.n=2;break}throw f("API request failed: Not authenticated"),new Error("Not authenticated. Please set your API key first.");case 2:return e.n=3,this.createResponse({model:t,input:n,text:y(i)});case 3:return a=e.v,c=v(null!==(o=a.content)&&void 0!==o?o:"No response content",i),u("Agent response:",c),e.a(2,c)}},e,this)})),function(e,t,n){return a.apply(this,arguments)})},{key:"loadApiKey",value:function(){u("Attempting to load API key from SessionStorage");try{var e=sessionStorage.getItem(P);if(e)try{var t=JSON.parse(e);if(t&&t.octagon_api_key)return this.apiKey=t.octagon_api_key,void u("API key loaded from CachedSessionSettings")}catch(e){l("Failed to parse CachedSessionSettings",e)}var n=sessionStorage.getItem(I);if(n)return this.apiKey=n,void u("API key loaded from direct SessionStorage")}catch(e){f("Failed to load API key from SessionStorage",e)}u("No API key found in SessionStorage")}},{key:"isAuthenticated",value:function(){return!!this.apiKey||(this.loadApiKey(),!!this.apiKey&&""!==this.apiKey.trim())}},{key:"clearApiKey",value:function(){this.apiKey=null;try{sessionStorage.removeItem(I);var e=sessionStorage.getItem(P);if(e)try{var t=JSON.parse(e);t&&(delete t.octagon_api_key,sessionStorage.setItem(P,JSON.stringify(t)))}catch(e){l("Failed to parse CachedSessionSettings for clearing",e)}u("API key cleared from all SessionStorage locations")}catch(e){f("Failed to clear API key from SessionStorage",e)}}},{key:"createResponse",value:(i=w(m().m(function e(t,n){var r,o,i,a,c;return m().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=new URL("/v1/responses",this.apiUrl),o=null!=n?n:this.apiKey){e.n=1;break}throw new Error("No API key provided");case 1:return e.p=1,i=new Headers({"Content-Type":"application/json",Authorization:"Bearer ".concat(o)}),e.n=2,fetch(r,{method:"POST",headers:i,body:JSON.stringify(t)});case 2:if((a=e.v).ok){e.n=3;break}throw f("Agent request failed: ".concat(a.status," ").concat(a.statusText),a.json()),new Error("Agent request failed: ".concat(a.status," ").concat(a.statusText));case 3:return e.n=4,this.parseAgentResponse(a);case 4:return e.a(2,e.v);case 5:throw e.p=5,c=e.v,new Error("Failed to create agent response: ".concat(c instanceof Error?c.message:"Unknown error"));case 6:return e.a(2)}},e,this,[[1,5]])})),function(e,t){return i.apply(this,arguments)})},{key:"parseAgentResponse",value:(o=w(m().m(function e(t){var n,r,o,i,a,c,s,u,l,p,y;return m().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,t.json();case 1:n=e.v,r="",o=h(n.output),e.p=2,o.s();case 3:if((i=o.n()).done){e.n=13;break}if("message"===(a=i.value).type){e.n=4;break}return e.a(3,12);case 4:c=h(a.content),e.p=5,c.s();case 6:if((s=c.n()).done){e.n=9;break}if("output_text"===(u=s.value).type){e.n=7;break}return e.a(3,8);case 7:r+=u.text;case 8:e.n=6;break;case 9:e.n=11;break;case 10:e.p=10,l=e.v,c.e(l);case 11:return e.p=11,c.f(),e.f(11);case 12:e.n=3;break;case 13:e.n=15;break;case 14:e.p=14,p=e.v,o.e(p);case 15:return e.p=15,o.f(),e.f(15);case 16:return e.a(2,{content:r,id:n.id,model:n.model});case 17:throw e.p=17,y=e.v,f("Error processing streamed response:",y),new Error("Failed to process streamed response: ".concat(y instanceof Error?y.message:"Unknown error"));case 18:return e.a(2)}},e,null,[[5,10,11,12],[2,14,15,16],[0,17]])})),function(e){return o.apply(this,arguments)})},{key:"testConnection",value:(r=w(m().m(function t(n){var r,o;return m().w(function(t){for(;;)switch(t.p=t.n){case 0:return u("Testing API connection with stored key"),r={model:e.OctagonAgent,input:"Test connection",max_tokens:10},t.p=1,t.n=2,this.createResponse(r,n);case 2:return t.a(2,!0);case 3:return t.p=3,o=t.v,f("Test connection threw an exception",o),t.a(2,!1)}},t,this,[[1,3]])})),function(e){return r.apply(this,arguments)})}],n&&O(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,r,o,i,a}(),j=new E;function _(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var s=r&&r.prototype instanceof c?r:c,u=Object.create(s.prototype);return N(u,"_invoke",function(n,r,o){var i,c,s,u=0,l=o||[],f=!1,p={p:0,n:0,v:e,a:y,f:y.bind(e,4),d:function(t,n){return i=t,c=0,s=e,p.n=n,a}};function y(n,r){for(c=n,s=r,t=0;!f&&u&&!o&&t<l.length;t++){var o,i=l[t],y=p.p,v=i[2];n>3?(o=v===r)&&(s=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=e):i[0]<=y&&((o=n<2&&y<i[1])?(c=0,p.v=r,p.n=i[1]):y<v&&(o=n<3||i[0]>r||r>v)&&(i[4]=n,i[5]=r,p.n=v,c=0))}if(o||n>1)return a;throw f=!0,r}return function(o,l,v){if(u>1)throw TypeError("Generator is already running");for(f&&1===l&&y(l,v),c=l,s=v;(t=c<2?e:s)||!f;){i||(c?c<3?(c>1&&(p.n=-1),y(c,s)):p.n=s:p.v=s);try{if(u=2,i){if(c||(o="next"),t=i[o]){if(!(t=t.call(i,s)))throw TypeError("iterator result is not an object");if(!t.done)return t;s=t.value,c<2&&(c=0)}else 1===c&&(t=i.return)&&t.call(i),c<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=e}else if((t=(f=p.n<0)?s:n.call(r,p))!==a)break}catch(t){i=e,c=1,s=t}finally{u=1}}return{value:t,done:f}}}(n,o,i),!0),u}var a={};function c(){}function s(){}function u(){}t=Object.getPrototypeOf;var l=[][r]?t(t([][r]())):(N(t={},r,function(){return this}),t),f=u.prototype=c.prototype=Object.create(l);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,N(e,o,"GeneratorFunction")),e.prototype=Object.create(f),e}return s.prototype=u,N(f,"constructor",u),N(u,"constructor",s),s.displayName="GeneratorFunction",N(u,o,"GeneratorFunction"),N(f),N(f,o,"Generator"),N(f,r,function(){return this}),N(f,"toString",function(){return"[object Generator]"}),(_=function(){return{w:i,m:p}})()}function N(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}N=function(e,t,n,r){function i(t,n){N(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},N(e,t,n,r)}function F(e,t,n,r,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,o)}function R(e,t){return T.apply(this,arguments)}function T(){var t;return t=_().m(function t(n,r){var o;return _().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,j.callAgent(e.OctagonAgent,n,r);case 1:return t.a(2,t.v);case 2:if(t.p=2,!((o=t.v)instanceof CustomFunctions.Error)){t.n=3;break}throw o;case 3:throw new CustomFunctions.Error(CustomFunctions.ErrorCode.notAvailable,o instanceof Error?o.message:"An unexpected error occurred");case 4:return t.a(2)}},t,null,[[0,2]])}),T=function(){var e=this,n=arguments;return new Promise(function(r,o){var i=t.apply(e,n);function a(e){F(i,r,o,a,c,"next",e)}function c(e){F(i,r,o,a,c,"throw",e)}a(void 0)})},T.apply(this,arguments)}Office.onReady(function(){try{s("Office is ready - initializing Octagon functions"),CustomFunctions.associate("OCTAGON.OCTAGON_AGENT",R)}catch(e){f("Error during initialization:",e)}}),CustomFunctions.associate("OCTAGON_AGENT",R)}();
//# sourceMappingURL=functions.js.map